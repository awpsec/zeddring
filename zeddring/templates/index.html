{% extends "base.html" %}

{% block title %}Zeddring Dashboard{% endblock %}

{% block content %}
<h2>Ring Dashboard</h2>

<div class="dashboard">
    <div class="card">
        <h3>Rings</h3>
        {% if rings %}
            <div class="ring-list">
                {% for ring in rings %}
                <div class="ring-item {% if ring.connected %}connected{% else %}disconnected{% endif %}">
                    <div class="ring-info">
                        <h4>{{ ring.name or 'Unnamed Ring' }}</h4>
                        <p>MAC: {{ ring.mac_address }}</p>
                        <p>Battery: {{ ring.battery_level or 'Unknown' }}%</p>
                        <p>Status: {% if ring.connected %}Connected{% else %}Disconnected{% endif %}</p>
                        <p>Last seen: {{ ring.last_seen or 'Never' }}</p>
                    </div>
                    <div class="ring-actions">
                        <a href="{{ url_for('ring_detail', ring_id=ring.id) }}" class="btn">View Details</a>
                        {% if ring.connected %}
                            <button class="btn disconnect-btn" data-ring-id="{{ ring.id }}">Disconnect</button>
                        {% else %}
                            <button class="btn connect-btn" data-ring-id="{{ ring.id }}">Connect</button>
                        {% endif %}
                        <button class="btn reboot-btn" data-ring-id="{{ ring.id }}">Reboot</button>
                        <button class="btn rename-btn" data-ring-id="{{ ring.id }}" data-ring-name="{{ ring.name or '' }}">Rename</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <p>No rings found. Make sure your rings are powered on and within range.</p>
        {% endif %}
    </div>
    
    <div class="card">
        <h3>Add New Ring</h3>
        <form id="add-ring-form">
            <div class="form-group">
                <label for="mac-address">MAC Address:</label>
                <input type="text" id="mac-address" name="mac-address" required placeholder="00:11:22:33:44:55">
            </div>
            <div class="form-group">
                <label for="ring-name">Name (optional):</label>
                <input type="text" id="ring-name" name="ring-name" placeholder="My Ring">
            </div>
            <button type="submit" class="btn">Add Ring</button>
        </form>
    </div>
</div>

<!-- Rename Modal -->
<div id="rename-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Rename Ring</h3>
        <form id="rename-form">
            <input type="hidden" id="rename-ring-id">
            <div class="form-group">
                <label for="new-name">New Name:</label>
                <input type="text" id="new-name" name="new-name" required>
            </div>
            <button type="submit" class="btn">Save</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Ring Form
        const addRingForm = document.getElementById('add-ring-form');
        if (addRingForm) {
            addRingForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const macAddress = document.getElementById('mac-address').value;
                const ringName = document.getElementById('ring-name').value;
                
                fetch('/api/ring/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        mac_address: macAddress,
                        name: ringName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while adding the ring.');
                });
            });
        }
        
        // Connect Buttons
        const connectBtns = document.querySelectorAll('.connect-btn');
        connectBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const ringId = this.dataset.ringId;
                
                fetch(`/api/ring/${ringId}/connect`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while connecting to the ring.');
                });
            });
        });
        
        // Disconnect Buttons
        const disconnectBtns = document.querySelectorAll('.disconnect-btn');
        disconnectBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const ringId = this.dataset.ringId;
                
                fetch(`/api/ring/${ringId}/disconnect`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while disconnecting from the ring.');
                });
            });
        });
        
        // Reboot Buttons
        const rebootBtns = document.querySelectorAll('.reboot-btn');
        rebootBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                if (!confirm('Are you sure you want to reboot this ring?')) {
                    return;
                }
                
                const ringId = this.dataset.ringId;
                
                fetch(`/api/ring/${ringId}/reboot`, {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Ring is rebooting. Please wait a moment before reconnecting.');
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while rebooting the ring.');
                });
            });
        });
        
        // Rename Modal
        const modal = document.getElementById('rename-modal');
        const renameBtns = document.querySelectorAll('.rename-btn');
        const closeBtn = document.querySelector('.close');
        const renameForm = document.getElementById('rename-form');
        
        renameBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const ringId = this.dataset.ringId;
                const ringName = this.dataset.ringName;
                
                document.getElementById('rename-ring-id').value = ringId;
                document.getElementById('new-name').value = ringName;
                
                modal.style.display = 'block';
            });
        });
        
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                modal.style.display = 'none';
            });
        }
        
        window.addEventListener('click', function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        });
        
        if (renameForm) {
            renameForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const ringId = document.getElementById('rename-ring-id').value;
                const newName = document.getElementById('new-name').value;
                
                fetch(`/api/ring/${ringId}/rename`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: newName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        modal.style.display = 'none';
                        window.location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while renaming the ring.');
                });
            });
        }
    });
</script>
{% endblock %} 